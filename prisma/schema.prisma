// Waypoint Cooperative - Prisma Schema
// ReBAC (Relationship-Based Access Control) Data Model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl is optional - used for migrations with Neon's connection pooler
  // If DATABASE_URL_UNPOOLED is not set, migrations will use DATABASE_URL
}

// =============================================================================
// ORGANIZATIONS
// =============================================================================
// Organizations are the primary actors in the system: GPs, LPs, Fund Admins, etc.
// The same organization can have different roles in different contexts.

model Organization {
  id        String   @id @default(cuid())
  name      String
  type      OrgType
  lei       String?  // Legal Entity Identifier for identity verification
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users              User[]
  managedAssets      Asset[]        @relation("AssetManager")
  subscriptions      Subscription[]
  grantsGiven        AccessGrant[]  @relation("Grantor")
  grantsReceived     AccessGrant[]  @relation("Grantee")
  publishedEnvelopes Envelope[]
  auditLogs          AuditLog[]

  @@index([type])
  @@index([lei])
}

// =============================================================================
// ASSETS
// =============================================================================
// Assets represent funds, feeders, SPVs, and portfolio companies.
// They form a hierarchy (Fund -> Feeder -> SPV -> PortCo).

model Asset {
  id                            String    @id @default(cuid())
  name                          String
  type                          AssetType
  managerId                     String
  requireGPApprovalForDelegations Boolean   @default(false)
  parentId                      String?
  vintage                       Int?      // Fund vintage year
  createdAt                     DateTime  @default(now())
  updatedAt                     DateTime  @updatedAt

  // Relations
  manager       Organization   @relation("AssetManager", fields: [managerId], references: [id], onDelete: Cascade)
  parent        Asset?         @relation("AssetHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children      Asset[]        @relation("AssetHierarchy")
  subscriptions Subscription[]
  envelopes     Envelope[]
  accessGrants  AccessGrant[]

  @@index([managerId])
  @@index([parentId])
  @@index([type])
}

// =============================================================================
// ACCESS GRANTS
// =============================================================================
// The atomic unit of delegation in the ReBAC model.
// Represents a directed edge from Grantor to Grantee with specific capabilities.

model AccessGrant {
  id        String      @id @default(cuid())
  grantorId String
  granteeId String
  assetId   String?     // null means all assets the grantor controls
  status    GrantStatus @default(PENDING_APPROVAL)

  // Capabilities - what the grantee can do
  canPublish             Boolean @default(false)
  canViewData            Boolean @default(false)
  canManageSubscriptions Boolean @default(false)
  canApproveDelegations  Boolean @default(false)

  // Lifecycle
  validFrom  DateTime  @default(now())
  expiresAt  DateTime?
  approvedBy String?
  approvedAt DateTime?
  revokedAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  grantor Organization @relation("Grantor", fields: [grantorId], references: [id], onDelete: Cascade)
  grantee Organization @relation("Grantee", fields: [granteeId], references: [id], onDelete: Cascade)
  asset   Asset?       @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([grantorId])
  @@index([granteeId])
  @@index([assetId])
  @@index([status])
}

// =============================================================================
// SUBSCRIPTIONS
// =============================================================================
// Represents an LP's investment relationship to an Asset.
// Creates implicit view rights for the subscriber.

model Subscription {
  id           String             @id @default(cuid())
  assetId      String
  subscriberId String
  status       SubscriptionStatus @default(ACTIVE)
  accessLevel  AccessLevel        @default(FULL)
  commitment   Float?             // Commitment amount in USD
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  // Relations
  asset      Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)
  subscriber Organization @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  @@unique([assetId, subscriberId])
  @@index([assetId])
  @@index([subscriberId])
  @@index([status])
}

// =============================================================================
// ENVELOPES
// =============================================================================
// Data packets published to the network (Capital Calls, Distributions, etc.)
// Supports versioning for corrections via parentId chain.

model Envelope {
  id          String       @id @default(cuid())
  type        DataArtifact
  payload     Json
  hash        String       // SHA-256 hash for integrity verification
  version     Int          @default(1)
  parentId    String?      // Points to previous version if this is a correction
  publisherId String
  assetId     String
  createdAt   DateTime     @default(now())

  // Relations
  publisher    Organization  @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  asset        Asset         @relation(fields: [assetId], references: [id], onDelete: Cascade)
  parent       Envelope?     @relation("Corrections", fields: [parentId], references: [id], onDelete: SetNull)
  children     Envelope[]    @relation("Corrections")
  readReceipts ReadReceipt[]

  @@index([publisherId])
  @@index([assetId])
  @@index([type])
  @@index([parentId])
  @@index([createdAt])
}

// =============================================================================
// READ RECEIPTS
// =============================================================================
// Tracks when users have viewed envelopes for audit purposes.

model ReadReceipt {
  id         String   @id @default(cuid())
  envelopeId String
  userId     String
  readAt     DateTime @default(now())

  // Relations
  envelope Envelope @relation(fields: [envelopeId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([envelopeId, userId])
  @@index([envelopeId])
  @@index([userId])
}

// =============================================================================
// USERS
// =============================================================================
// Individual users belonging to organizations.

model User {
  id             String   @id @default(cuid())
  name           String
  email          String   @unique
  organizationId String
  role           UserRole @default(MEMBER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  readReceipts ReadReceipt[]
  auditLogs    AuditLog[]    @relation("AuditActor")

  @@index([organizationId])
  @@index([email])
}

// =============================================================================
// AUDIT LOG
// =============================================================================
// Immutable log of all significant actions in the system.

model AuditLog {
  id             String   @id @default(cuid())
  action         String   // e.g., "CREATE", "UPDATE", "DELETE", "APPROVE", "REVOKE"
  entityType     String   // e.g., "AccessGrant", "Subscription", "Envelope"
  entityId       String
  actorId        String?
  organizationId String?
  details        Json?    // Additional context about the action
  createdAt      DateTime @default(now())

  // Relations
  actor        User?         @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([organizationId])
  @@index([createdAt])
}

// =============================================================================
// ENUMS
// =============================================================================

enum OrgType {
  GP             // General Partner / Asset Manager
  LP             // Limited Partner / Investor
  FUND_ADMIN     // Fund Administrator
  AUDITOR        // Audit firm
  CONSULTANT     // Investment Consultant
  TAX_ADVISOR    // Tax Advisor
  PLATFORM_ADMIN // Waypoint Platform Admin
}

enum AssetType {
  FIRM              // Asset Management Firm
  FUND              // Main Fund vehicle
  FEEDER            // Feeder Fund
  SPV               // Special Purpose Vehicle
  PORTFOLIO_COMPANY // Portfolio Company
}

enum GrantStatus {
  ACTIVE           // Grant is currently in effect
  PENDING_APPROVAL // Awaiting GP approval
  REVOKED          // Grant has been revoked
  EXPIRED          // Grant has passed its expiration date
}

enum SubscriptionStatus {
  ACTIVE  // Active investment
  PENDING // Pending subscription
  CLOSED  // Closed/redeemed position
}

enum AccessLevel {
  FULL       // Full access to all data
  RESTRICTED // Restricted/sanitized access
}

enum DataArtifact {
  CAPITAL_CALL        // Capital call notice
  DISTRIBUTION        // Distribution notice
  FINANCIAL_STATEMENT // Quarterly/annual financial statements
  TAX_DOCUMENT        // K-1, PFIC statements
  LEGAL_DOCUMENT      // Side letters, amendments
}

enum UserRole {
  ADMIN  // Organization admin - full access
  MEMBER // Standard member
  VIEWER // Read-only access
}

