// Waypoint Cooperative - Prisma Schema
// ReBAC (Relationship-Based Access Control) Data Model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl is optional - used for migrations with Neon's connection pooler
  // If DATABASE_URL_UNPOOLED is not set, migrations will use DATABASE_URL
}

// =============================================================================
// ORGANIZATIONS
// =============================================================================
// Organizations are the primary actors in the system: GPs, LPs, Fund Admins, etc.
// The same organization can have different roles in different contexts.
// OrgType is optional/informational - actual roles are derived from relationships.

model Organization {
  id        String   @id @default(cuid())
  name      String
  type      String?  // Optional - informational only, not used for access control. Examples: 'GP', 'LP', 'FUND_ADMIN', 'AUDITOR', 'CONSULTANT', 'TAX_ADVISOR', 'PLATFORM_ADMIN'
  lei       String?  // Legal Entity Identifier for identity verification
  narrative String?  // Organization description/mission statement
  imageUrl  String?  // Legacy: external image URL for branding
  imageData Bytes?   // Binary image data stored in database
  imageMime String?  // MIME type of stored image (e.g., image/png)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users              User[]
  managedAssets      Asset[]        @relation("AssetManager")
  subscriptions      Subscription[]
  grantsGiven        AccessGrant[]  @relation("Grantor")
  grantsReceived     AccessGrant[]  @relation("Grantee")
  publishedDataPackets DataPacket[]
  auditLogs          AuditLog[]

  @@index([lei])
}

// =============================================================================
// ASSETS
// =============================================================================
// Assets represent funds, feeders, SPVs, and portfolio companies.
// They form a hierarchy (Fund -> Feeder -> SPV -> PortCo).

model Asset {
  id                            String    @id @default(cuid())
  name                          String
  type                          String    // Examples: 'FIRM', 'FUND', 'FEEDER', 'SPV', 'PORTFOLIO_COMPANY'. Extensible for future types.
  managerId                     String
  requireGPApprovalForDelegations Boolean   @default(false)
  parentId                      String?
  vintage                       Int?      // Fund vintage year
  createdAt                     DateTime  @default(now())
  updatedAt                     DateTime  @updatedAt

  // Relations
  manager       Organization       @relation("AssetManager", fields: [managerId], references: [id], onDelete: Cascade)
  parent        Asset?             @relation("AssetHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children      Asset[]            @relation("AssetHierarchy")
  subscriptions Subscription[]
  dataPackets   DataPacket[]
  accessGrants  AccessGrant[]      // Legacy single-asset grants
  grantAssets   AccessGrantAsset[] // Multi-asset grant junction

  @@index([managerId])
  @@index([parentId])
  @@index([type])
}

// =============================================================================
// ACCESS GRANTS
// =============================================================================
// The atomic unit of delegation in the ReBAC model.
// Represents a directed edge from Grantor to Grantee with specific capabilities.
// Supports multi-asset grants via the AccessGrantAsset junction table.

model AccessGrant {
  id        String      @id @default(cuid())
  grantorId String
  granteeId String
  assetId   String?     // Deprecated: use grantAssets for multi-asset support. null means all assets.
  status    GrantStatus @default(PENDING_APPROVAL)

  // Capabilities - what the grantee can do
  canPublish             Boolean @default(false)
  canViewData            Boolean @default(false)
  canManageSubscriptions Boolean @default(false)
  canApproveDelegations  Boolean @default(false)

  // Lifecycle
  validFrom  DateTime  @default(now())
  expiresAt  DateTime?
  approvedBy String?
  approvedAt DateTime?
  revokedAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  grantor     Organization       @relation("Grantor", fields: [grantorId], references: [id], onDelete: Cascade)
  grantee     Organization       @relation("Grantee", fields: [granteeId], references: [id], onDelete: Cascade)
  asset       Asset?             @relation(fields: [assetId], references: [id], onDelete: Cascade)
  grantAssets AccessGrantAsset[] // Multi-asset support

  @@index([grantorId])
  @@index([granteeId])
  @@index([assetId])
  @@index([status])
}

// =============================================================================
// ACCESS GRANT ASSETS (Junction Table)
// =============================================================================
// Many-to-many relationship between AccessGrants and Assets.
// Allows a single grant to apply to multiple assets.

model AccessGrantAsset {
  id      String @id @default(cuid())
  grantId String
  assetId String

  // Relations
  grant AccessGrant @relation(fields: [grantId], references: [id], onDelete: Cascade)
  asset Asset       @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([grantId, assetId])
  @@index([grantId])
  @@index([assetId])
}

// =============================================================================
// SUBSCRIPTIONS
// =============================================================================
// Represents an LP's investment relationship to an Asset.
// Creates implicit view rights for the subscriber.
// Supports temporal tracking: validFrom/validTo enable ownership transfer history.

model Subscription {
  id           String             @id @default(cuid())
  assetId      String
  subscriberId String
  status       SubscriptionStatus @default(ACTIVE)
  accessLevel  AccessLevel        @default(FULL)
  commitment   Float?             // Commitment amount in USD
  validFrom    DateTime           @default(now()) // When subscription became active
  validTo      DateTime?          // When subscription ended (null = currently active)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  // Relations
  asset      Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)
  subscriber Organization @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  // Note: No unique constraint - allows historical records of same LP holding same asset at different times
  @@index([assetId])
  @@index([subscriberId])
  @@index([status])
  @@index([assetId, subscriberId, validFrom])
  @@index([validTo])
}

// =============================================================================
// DATA PACKETS
// =============================================================================
// Data packets published to the network (Capital Calls, Distributions, etc.)
// Supports versioning for corrections via parentId chain.

model DataPacket {
  id          String       @id @default(cuid())
  type        DataArtifact
  payload     Json
  hash        String       // SHA-256 hash for integrity verification
  version     Int          @default(1)
  parentId    String?      // Points to previous version if this is a correction
  publisherId String
  assetId     String
  createdAt   DateTime     @default(now())

  // Relations
  publisher    Organization  @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  asset         Asset         @relation(fields: [assetId], references: [id], onDelete: Cascade)
  parent        DataPacket?   @relation("Corrections", fields: [parentId], references: [id], onDelete: SetNull)
  children      DataPacket[]  @relation("Corrections")
  readReceipts  ReadReceipt[]

  @@index([publisherId])
  @@index([assetId])
  @@index([type])
  @@index([parentId])
  @@index([createdAt])
}

// =============================================================================
// READ RECEIPTS
// =============================================================================
// Tracks when users have viewed data packets for audit purposes.

model ReadReceipt {
  id            String   @id @default(cuid())
  dataPacketId  String
  userId        String
  readAt        DateTime @default(now())

  // Relations
  dataPacket DataPacket @relation(fields: [dataPacketId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dataPacketId, userId])
  @@index([dataPacketId])
  @@index([userId])
}

// =============================================================================
// USERS
// =============================================================================
// Individual users belonging to organizations.

model User {
  id             String   @id @default(cuid())
  name           String
  email          String   @unique
  organizationId String
  role           UserRole @default(MEMBER)
  narrative      String?  // Personal bio/description
  pictureUrl     String?  // Legacy: external profile picture URL
  pictureData    Bytes?   // Binary image data stored in database
  pictureMime    String?  // MIME type of stored image (e.g., image/png)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  readReceipts ReadReceipt[]
  auditLogs    AuditLog[]    @relation("AuditActor")

  @@index([organizationId])
  @@index([email])
}

// =============================================================================
// AUDIT LOG
// =============================================================================
// Immutable log of all significant actions in the system.

model AuditLog {
  id             String   @id @default(cuid())
  action         String   // e.g., "CREATE", "UPDATE", "DELETE", "APPROVE", "REVOKE"
  entityType     String   // e.g., "AccessGrant", "Subscription", "DataPacket"
  entityId       String
  actorId        String?
  organizationId String?
  details        Json?    // Additional context about the action
  createdAt      DateTime @default(now())

  // Relations
  actor        User?         @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([organizationId])
  @@index([createdAt])
}

// =============================================================================
// ENUMS
// =============================================================================
// Note: OrgType and AssetType removed - now using String for extensibility.
// Remaining enums represent governance states, not extensible entity types.

enum GrantStatus {
  ACTIVE           // Grant is currently in effect
  PENDING_APPROVAL // Awaiting GP approval
  REVOKED          // Grant has been revoked
  EXPIRED          // Grant has passed its expiration date
}

enum SubscriptionStatus {
  ACTIVE  // Active investment
  PENDING // Pending subscription
  CLOSED  // Closed/redeemed position
}

enum AccessLevel {
  FULL       // Full access to all data
  RESTRICTED // Restricted/sanitized access
}

enum DataArtifact {
  CAPITAL_CALL        // Capital call notice
  DISTRIBUTION        // Distribution notice
  FINANCIAL_STATEMENT // Quarterly/annual financial statements
  TAX_DOCUMENT        // K-1, PFIC statements
  LEGAL_DOCUMENT      // Side letters, amendments
}

enum UserRole {
  ADMIN  // Organization admin - full access
  MEMBER // Standard member
  VIEWER // Read-only access
}

